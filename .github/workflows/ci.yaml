name: CI

on:
  push:
  pull_request:

jobs:
  run-tests:
    strategy:
      fail-fast: false
      matrix: 
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: 
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12-dev"

    name: Test
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          python -m pip install pytest 
          pip install -r requirements.txt
          pip install pytest
          pip install pytest-cov
          pip install --force-reinstall pytest pytest-mock
          pip install pytest-playwright
          playwright install

      - name: Run Flask     # And save process ID
        run: |
          python app.py & 
          echo $! > flask.pid
          sleep 10
        shell: bash

      - name: Wait For Flask to Be Ready
        run: |
          echo "waiting for Flask to start..."
          for i in {1..10}; do 
            if curl -f http://127.0.0.1:5000/ 2>/dev/null; then
              echo "Flask is ready."
              break
            fi
            sleep 1
            if [ $i -eq 120 ]; then
              echo "Flask failed to start within 2 minutes."
              cat flask.log || true
              exit 1
            fi
          done
        shell: bash

      # - name: Check if Flask log exists and show content
      #   run: |
      #     if [ -f flask.log ]; then
      #       echo "Flask log found:"
      #       cat flask.log
      #     else
      #       echo "Flask log not found!"
      #       ls -la
      #     fi
      #   shell: bash

      # - name: Check if Flask is running
      #   run: |
      #     if [ -f flask.pid ]; then
      #       PID=$(cat flask.pid)
      #       echo "Flask PID: $PID"
      #       ps -p $PID || echo "Process $PID not running"
      #     else
      #       echo "No PID file found"
      #     fi
      #     echo "Checking port 5000:"
      #     curl -v http://127.0.0.1:5000/ || echo "Flask not responding"
      #   shell: bash

      - name: Run tests
        run: |
          python -m pytest -v
          python -m pytest --cov=services --cov=. --cov-report=xml --cov-report=term -v
          python -m pytest --cov=services --cov=. --cov-branch --cov-report=xml --cov-report=term -v

      # - name: Show Flask logs if tests fail
      #   if: failure()
      #   run: |
      #     if [ -f flask.log ]; then
      #       cat flask.log
      #     fi
      #   shell: bash

      - name: Stop Flask app
        if: always()
        run: |
          if [ -f flask.pid ]; then
            kill $(cat flask.pid) || true
          fi
        shell: bash